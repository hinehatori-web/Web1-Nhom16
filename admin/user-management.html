<script>
/* =========================
   User management prototype — FIXED USERS VERSION
   Luôn khởi tạo 5 user cố định nếu chưa tồn tại.
   ========================= */

const LS_KEY = 'ADM_users';
const wrap = document.getElementById('tableWrap');
const totalCount = document.getElementById('totalCount');
const searchInput = document.getElementById('searchInput');

function lsGet(){ 
  try{ return JSON.parse(localStorage.getItem(LS_KEY)) || []; }
  catch(e){ return []; }
}
function lsSet(v){ localStorage.setItem(LS_KEY, JSON.stringify(v)); }

/* ----------- FIXED USERS ----------- */
const FIXED_USERS = [
  { id: "u001", username: "hinatori", email: "hina@example.com", password: "123456", locked: false, createdAt: "2024-02-01T08:00:00" },
  { id: "u002", username: "aqua", email: "aqua@vtuber.jp", password: "pass001", locked: false, createdAt: "2024-02-03T11:20:00" },
  { id: "u003", username: "kazu", email: "kazu@mail.com", password: "kazu789", locked: false, createdAt: "2024-03-02T14:10:00" },
  { id: "u004", username: "adminsub", email: "sub@admin.com", password: "admin123", locked: false, createdAt: "2024-01-12T18:22:00" },
  { id: "u005", username: "valorant_gamer", email: "valo@riot.com", password: "valo456", locked: false, createdAt: "2024-04-10T09:45:00" }
];

/* Luôn khởi tạo 5 user này nếu localStorage rỗng */
function initFixedUsers() {
  let data = lsGet();

  if (data.length === 0) {
    lsSet([...FIXED_USERS]);
    return;
  }

  // Nếu người dùng xóa bớt → thêm lại
  FIXED_USERS.forEach(baseUser => {
    if (!data.some(u => u.id === baseUser.id)) {
      data.push(baseUser);
    }
  });

  lsSet(data);
}

/* ------------------- UI rendering ------------------- */

function renderTable(filter=''){
  const users = lsGet();
  const f = (filter || '').toLowerCase().trim();
  const list = f ? users.filter(u => u.username.toLowerCase().includes(f) || u.email.toLowerCase().includes(f)) : users;
  totalCount.textContent = list.length;

  if(list.length===0){
    wrap.innerHTML = '<div class="small muted center" style="padding:30px">Không có user.</div>';
    return;
  }

  let html = '<table><thead><tr><th>Tài khoản</th><th>Email</th><th>Trạng thái</th><th>Thao tác</th></tr></thead><tbody>';

  list.forEach(u=>{
    html += `<tr class="${u.locked ? 'locked' : ''}">
      <td><strong>${escapeHtml(u.username)}</strong><br>
        <div class="small muted">Tạo: ${new Date(u.createdAt).toLocaleString()}</div>
      </td>
      <td>${escapeHtml(u.email)}</td>
      <td>${u.locked ? '<span class="badge">Đã khóa</span>' : '<span class="badge">Hoạt động</span>'}</td>
      <td>
        <button class="btn-sm btn-reset" onclick="resetPassword('${u.id}')">Reset mật khẩu</button>
        <button class="btn-sm btn-lock" onclick="toggleLock('${u.id}')">${u.locked ? 'Mở khóa' : 'Khóa'}</button>
        <button class="btn-sm ghost" onclick="editUser('${u.id}')">Sửa</button>
        <button class="btn-sm danger" onclick="deleteUser('${u.id}')">Xóa</button>
      </td>
    </tr>`;
  });

  html += '</tbody></table>';
  wrap.innerHTML = html;
}

/* Escape */
function escapeHtml(s){
  if(!s) return '';
  return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
  .replaceAll('"','&quot;').replaceAll("'",'&#39;');
}

/* ------------------- Actions ------------------- */

function resetPassword(id){
  let users = lsGet();
  const u = users.find(x=>x.id===id);
  if(!u) return alert("Không tìm thấy user");

  if(!confirm("Reset mật khẩu cho " + u.username + "?")) return;

  const newPass = "reset" + Math.floor(Math.random()*90000+1000);
  u.password = newPass;

  lsSet(users);
  renderTable();
  alert("Mật khẩu mới của " + u.username + ":\n\n" + newPass);
}

function toggleLock(id){
  let users = lsGet();
  const u = users.find(x=>x.id===id);
  u.locked = !u.locked;
  lsSet(users);
  renderTable();
}

function editUser(id){
  let users = lsGet();
  let u = users.find(x=>x.id===id);

  document.getElementById('f_username').value = u.username;
  document.getElementById('f_email').value = u.email;
  document.getElementById('f_password').value = "";

  document.getElementById('btnSave').dataset.editId = id;
}

function deleteUser(id){
  if(!confirm("Xóa user này?")) return;
  let users = lsGet();
  users = users.filter(x=>x.id !== id);
  lsSet(users);

  initFixedUsers(); // đảm bảo đủ 5 user
  renderTable();
}

/* ------------------- SAVE FORM ------------------- */

document.getElementById('btnSave').addEventListener('click', ()=>{
  const uVal = f_username.value.trim();
  const eVal = f_email.value.trim();
  const pVal = f_password.value;

  let users = lsGet();

  const editId = btnSave.dataset.editId;
  if(editId){
    const u = users.find(x=>x.id===editId);
    u.username = uVal;
    u.email = eVal;
    if(pVal) u.password = pVal;
    lsSet(users);
    delete btnSave.dataset.editId;
  }

  resetForm();
  renderTable();
});

function resetForm(){
  f_username.value = '';
  f_email.value = '';
  f_password.value = '';
  delete btnSave.dataset.editId;
}

/* Search */
searchInput.addEventListener('input', e => renderTable(e.target.value));

/* RUN INIT */
initFixedUsers();
renderTable();

/* Expose */
window.resetPassword = resetPassword;
window.toggleLock = toggleLock;
window.editUser = editUser;
window.deleteUser = deleteUser;
</script>
